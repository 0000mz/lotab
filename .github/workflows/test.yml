name: Test

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: install-mv
        run: brew install uv
      - name: install-playwright
        run: uvx playwright install
      - name: build
        run: |
          ./build.sh 2>&1 | \
            tee >(.github/scripts/push-to-loki.sh \
            "https://loki.bmo.land/loki/api/v1/push" "${{ github.run_id }}" "build")
      - name: client-test (asan)
        run: |
          ./build/debug/client_test_asan 2>&1 | \
            tee >(.github/scripts/push-to-loki.sh \
            "https://loki.bmo.land/loki/api/v1/push" "${{ github.run_id }}" "client-test-asan")
      - name: engine-test (asan)
        run: |
          ./build/debug/engine_test_asan 2>&1 | \
            tee >(.github/scripts/push-to-loki.sh \
            "https://loki.bmo.land/loki/api/v1/push" "${{ github.run_id }}" "engine-test-asan")
      - name: integration-test (asan)
        run: |
          ./build/debug/integration_test_asan 2>&1 | \
            tee >(.github/scripts/push-to-loki.sh \
            "https://loki.bmo.land/loki/api/v1/push" "${{ github.run_id }}" "integration-test-asan")
      - name: client-mode-test (asan)
        run: |
          ./build/debug/client_mode_test_asan 2>&1 | \
            tee >(.github/scripts/push-to-loki.sh \
            "https://loki.bmo.land/loki/api/v1/push" "${{ github.run_id }}" "client-mode-test-asan")
      - name: e2e-test
        run: |
          for i in {1..3}; do
            echo "Attempt $i of 3"
            if meson test -C build/debug -v e2e_test; then
              exit 0
            fi
            sleep 5
          done
          exit 1
      - name: grafana-link
        if: always()
        run: |
          # 1. Variables
          GRAFANA_URL="https://monitor.bmo.land"
          RUN_ID="${{ github.run_id }}"

          # 2. Build and URL-encode the JSON object entirely within jq
          # We use string interpolation \() instead of + to build the LogQL query
          QUERY_JSON=$(jq -n \
            --arg rid "$RUN_ID" \
            '{"w0n":
              {"datasource":"df9fo7h43t1j4a",
                "queries":
                  [{"refId":"A","expr":"{job=\"macos-build\", run_id=\"\($rid)\"}",
                  "queryType":"range",
                  "datasource":
                    {"type":"loki","uid":"df9fo7h43t1j4a"},
                  "editorMode":"code","direction":"backward"}],
                "range":{"from":"now-1h","to":"now"},"compact":false}
              } | @uri')

          # 3. Create and post the link
          FULL_URL="${GRAFANA_URL}/explore?left=${QUERY_JSON}"

          echo "### ðŸ“‹ Build Logs" >> $GITHUB_STEP_SUMMARY
          echo "[view logs via grafana]($FULL_URL)" >> $GITHUB_STEP_SUMMARY
